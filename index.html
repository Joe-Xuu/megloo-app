<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Re:Turn Borrow System</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
/* --- 1. å¼€å±åŠ¨ç”»æ ·å¼ (Splash Screen) --- */
      #splash-screen {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(135deg, #06C755 0%, #04a847 100%); /* ç¨å¾®åŠ ç‚¹æ¸å˜æ›´æœ‰è´¨æ„Ÿ */
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column; /* æ”¹ä¸ºçºµå‘æ’åˆ— */
        transition: opacity 0.8s ease-out, visibility 0.8s;
        padding: 20px;
        box-sizing: border-box;
      }

      /* ä¸»æ ‡é¢˜å®¹å™¨ */
      .splash-content {
        text-align: center;
        color: white;
      }

      /* ä¸»æ ‡é¢˜ (Re:Turn) */
      .splash-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 56px;
        font-weight: 900;
        letter-spacing: 3px;
        margin-bottom: 20px;
        text-shadow: 0 4px 10px rgba(0,0,0,0.1);
        animation: scalePulse 2s infinite;
      }

      /* å‰¯æ ‡é¢˜åŒºåŸŸ */
      .splash-sub {
        font-family: 'Montserrat', sans-serif;
        opacity: 0; /* åˆå§‹éšè—ï¼Œé åŠ¨ç”»æ˜¾ç¤º */
        transform: translateY(20px);
        animation: fadeInUp 0.6s ease-out forwards;
      }

      /* ç¬¬ä¸€ç»„ï¼šCredit */
      .sub-credit-group {
        margin-bottom: 15px;
      }
      .sub-org {
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 1px;
        margin-bottom: 4px;
      }
      .sub-author {
        font-size: 11px;
        font-weight: 500;
        opacity: 0.9;
      }

      /* åˆ†éš”çº¿ */
      .sub-divider {
        width: 40px;
        height: 2px;
        background: rgba(255,255,255,0.6);
        margin: 0 auto 15px auto;
        border-radius: 2px;
      }

      /* ç¬¬äºŒç»„ï¼šSlogan */
      .sub-slogan-group {
        text-transform: uppercase;
      }
      .sub-3r {
        font-size: 16px;
        font-weight: 800;
        letter-spacing: 2px;
        margin-bottom: 4px;
      }
      .sub-action {
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 1px;
        opacity: 0.8;
        font-style: italic;
      }

      /* åŠ¨ç”»å»¶è¿Ÿè®¾ç½® */
      .delay-1 { animation-delay: 0.2s; }
      .delay-2 { animation-delay: 0.3s; }
      .delay-3 { animation-delay: 0.4s; }
      .delay-4 { animation-delay: 0.5s; }
      .delay-5 { animation-delay: 0.6s; }

      /* ä¸Šæµ®æ¸ç°åŠ¨ç”» */
      @keyframes fadeInUp {
        to { opacity: 1; transform: translateY(0); }
      }

      /* å¼€å±æ¶ˆå¤±çš„ç±» */
      .fade-out {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      /* --- å…¨å±€æ ·å¼ --- */
      body {
        font-family: "Noto Sans JP", -apple-system, sans-serif;
        background-color: #ffffff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px 0;
        color: #333;
      }

      /* --- 2. Logo æ ·å¼ --- */
      .top-logo {
        height: 50px; /* æ ¹æ®å®é™…å›¾ç‰‡è°ƒæ•´ */
        margin-bottom: 20px;
        object-fit: contain;
      }
      
      .bottom-logos {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 30px;
        margin-bottom: 10px;
      }
      .small-logo {
        height: 30px; /* åº•éƒ¨ Logo å°ä¸€ç‚¹ */
        opacity: 0.8;
      }

      /* --- å¡ç‰‡å®¹å™¨ --- */
      .card {
        background: white;
        width: 85%;
        max-width: 340px;
        padding: 40px 30px;
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        border: 1px solid #f0f0f0;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      /* --- å­—ä½“ä¸IDæ ·å¼ --- */
      h1 { margin: 0; font-size: 22px; font-weight: 700; color: #111; }
      p.subtitle { margin: 5px 0 25px 0; font-size: 12px; color: #888; }

      .id-wrapper {
        background: #F7F9FB;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px dashed #E0E0E0;
      }
      .label { font-size: 11px; font-weight: 700; color: #06C755; display: block; margin-bottom: 5px;}
      .container-id { font-size: 36px; font-weight: 800; color: #333; font-family: 'Montserrat', sans-serif;}

      /* --- æŒ‰é’®æ ·å¼ --- */
      button {
        background-color: #06C755; color: white; border: none; padding: 16px;
        font-size: 16px; border-radius: 50px; width: 100%; font-weight: 700;
        cursor: pointer; box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3);
        transition: transform 0.1s;
      }
      button:active { transform: scale(0.96); }
      button:disabled { background-color: #E0E0E0; color: #999; box-shadow: none; }

/* --- 3. (Eco Impact) --- */
      .success-view { display: none; }
      
      .impact-box {
        background: #f0fdf4; /* æµ…ç»¿è‰²èƒŒæ™¯ */
        border: 1px solid #b9f6ca;
        border-radius: 12px;
        padding: 15px;
        margin-top: 15px;
        text-align: left; /* åˆ—è¡¨æ”¹ä¸ºå·¦å¯¹é½ */
        animation: slideUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .impact-section-title {
        font-size: 11px;
        font-weight: 700;
        color: #05a045;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .impact-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #555;
        margin-bottom: 4px;
        padding-left: 16px; /* ç¼©è¿›ä¸€ç‚¹ */
      }

      .impact-val {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        color: #06C755;
      }

      .impact-divider {
        border-top: 1px dashed #b9f6ca;
        margin: 8px 0 10px 0;
      }

      .source-note {
        font-size: 9px;
        color: #999;
        text-align: right;
        margin-top: 8px;
        font-style: italic;
        font-family: 'Montserrat', sans-serif;
      }

      /* --- åŠ¨ç”» Keyframes --- */
      @keyframes scalePulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes popIn {
        from { transform: scale(0); } 
        to { transform: scale(1); }
      }

      .credit { margin-top: 40px; font-size: 8px; color: #B0B0B0; font-family: sans-serif;}
    </style>
  </head>
<body>

    <div id="splash-screen">
      <div class="splash-content">
        <div class="splash-title">Re:Turn</div>
        
        <div class="splash-sub sub-credit-group delay-1">
          <div class="sub-org">SFC Wada Lab & Megloo</div>
          <div class="sub-author">Presented by Kouzen Jo</div>
        </div>
        
        <div class="splash-sub sub-divider delay-2"></div>
        
        <div class="splash-sub sub-slogan-group">
          <!-- <div class="sub-3r delay-3">Reduce & Reuse & Recycle</div> -->
          <div class="sub-action delay-4">Think big, start small.</div>
        </div>
      </div>
    </div>

    <img src="sfc_logo.png" class="top-logo" alt="Keio SFC">

    <div class="card" id="main-card">
      <div id="borrow-view">
        <h1>Re:Turn è²¸å‡ºã‚·ã‚¹ãƒ†ãƒ </h1>
        <p class="subtitle">ã“ã®å®¹å™¨ã‚’å€Ÿã‚Šã¾ã™ã‹ï¼Ÿ</p>
        
        <div class="id-wrapper">
          <span class="label">Container ID</span>
          <div id="cid-display" class="container-id">...</div>
        </div>
        
        <button id="btn-borrow" onclick="handleBorrow()" disabled>
          Loading System...
        </button>
      </div>

<div id="success-view" class="success-view">
        <div style="font-size: 60px; color: #06C755; animation: popIn 0.5s;">âœ“</div>
        <h2 style="margin: 10px 0;">è²¸å‡ºå®Œäº†</h2>
        
        <div class="impact-box">
          
          <div class="impact-section-title">
            <span>ğŸƒ</span> CO2å‰Šæ¸›è²¢çŒ®
          </div>
          <div class="impact-row">
            <span>å¯¾ç´™å®¹å™¨</span>
            <span class="impact-val">-7.2g<span style="font-size:10px">*</span></span>
          </div>
          <div class="impact-row">
            <span>å¯¾ãƒ—ãƒ©å®¹å™¨</span>
            <span class="impact-val">-13.9g<span style="font-size:10px">*</span></span>
          </div>

          <div class="impact-divider"></div>

          <div class="impact-section-title">
            <span>ğŸ—‘ï¸</span> ã‚´ãƒŸå‰Šæ¸›é‡
          </div>
          <div class="impact-row">
            <span>ç´™ã‚´ãƒŸ</span>
            <span class="impact-val">-3.6g<span style="font-size:10px">*</span></span>
          </div>
          <div class="impact-row">
            <span>ãƒ—ãƒ©ã‚´ãƒŸ</span>
            <span class="impact-val">-2.1g<span style="font-size:10px">*</span></span>
          </div>

          <div class="source-note">source: megloo Inc.</div>
        </div>
        
        <p style="color:#999; font-size:12px; margin-top:20px;">
          ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼<br>
          ç¾å‘³ã—ãå¬ã—ä¸ŠãŒã‚ŒğŸ±
        </p>
      </div>

    <div class="bottom-logos">
      <img src="lab_logo.png" class="small-logo" alt="Lab Logo">
      <img src="megloo_logo.png" class="small-logo" alt="Megloo Logo">
    </div>

    <div class="credit">
        Keio SFC Wada Lab | 2025 Â© Designed & Developed by Kouzen Jo
    </div>

    <script>
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYsPwEGhJini_bABdYEZ1l4M-SOaRN-JkCMSdhaVY8ycf4JfvtthsXM2xUIzaTuaBwfg/exec";
      const MY_LIFF_ID = "2008626930-AddPwDy7"; 

      let containerId = "";

      window.onload = function() {
        // --- å¼€å±åŠ¨ç”»é€»è¾‘ ---
        // é¡µé¢åŠ è½½ 1.5ç§’ åï¼Œè®©ç»¿è‰²å±å¹•æ¶ˆå¤±
        setTimeout(() => {
          document.getElementById('splash-screen').classList.add('fade-out');
        }, 2200);

        // --- get id ---
        const urlParams = new URLSearchParams(window.location.search);
        containerId = urlParams.get('id');
        if (!containerId) {
          const liffState = urlParams.get('liff.state');
          if (liffState && liffState.includes('id=')) containerId = liffState.split('id=')[1];
        }

        if (containerId) {
          document.getElementById('cid-display').innerText = containerId;
          initializeLiff();
        } else {
          document.getElementById('cid-display').innerText = "ERROR";
          document.getElementById('btn-borrow').innerText = "QRã‚¨ãƒ©ãƒ¼";
        }
      };

      function initializeLiff() {
        liff.init({ liffId: MY_LIFF_ID }).then(() => {
          if (liff.isLoggedIn()) {
             readyToGo();
          } else {
             liff.login(); 
          }
        });
      }

      function readyToGo() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = false;
        btn.innerText = "ã¯ã„";
      }

      function handleBorrow() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        const idToken = liff.getDecodedIDToken();
        if (!idToken) { location.reload(); return; }
        const userId = idToken.sub;

    //     fetch(GAS_API_URL, {
    //       method: 'POST',
    //       mode: 'no-cors', 
    //       headers: { 'Content-Type': 'application/json' },
    //       body: JSON.stringify({ userId: userId, containerId: containerId })
    //     }).then(() => {
    //       showSuccessAnimation();
    //     }).catch(err => {
    //       alert("Error: " + err);
    //       btn.disabled = false;
    //       btn.innerText = "Retry";
    //     });
    //   }

    //   function showSuccessAnimation() {
    //     // éšè—å€Ÿå‡ºç•Œé¢ï¼Œæ˜¾ç¤ºæˆåŠŸç•Œé¢
    //     document.getElementById('borrow-view').style.display = 'none';
    //     document.getElementById('success-view').style.display = 'block';
        
    //     // 3ç§’åè‡ªåŠ¨å…³é—­
    //     setTimeout(() => {
    //       liff.closeWindow();
    //     }, 3000);
    //   }

    fetch(GAS_API_URL, {
        method: 'POST',
        //ä¸è¦åŠ  mode: 'no-cors'ï¼Œå¦åˆ™è¯»ä¸åˆ°è¿”å›å€¼
        // Content-Type text/plainï¼Œ
        // è™½ç„¶æˆ‘ä»¬å‘çš„æ˜¯ JSON å­—ç¬¦ä¸²ï¼Œä½†åœ¨ GAS ä¸­è¿™æ ·å†™èƒ½é¿å…è·¨åŸŸ(CORS)é¢„æ£€æŠ¥é”™
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        
        body: JSON.stringify({ userId: userId, containerId: containerId })
        })
        .then(response => response.json()) // è§£æåç«¯è¿”å›çš„ JSON
        .then(data => {
        // ğŸŸ¢ å…³é”®ç‚¹3ï¼šæ ¹æ®åç«¯è¿”å›çš„çŠ¶æ€æ¥å†³å®šæ˜¾ç¤ºä»€ä¹ˆ
        if (data.status === 'SUCCESS') {
            // æˆåŠŸï¼šæ˜¾ç¤ºåŠ¨ç”»
            showSuccessAnimation();
        } else if (data.code === 'ALREADY_BORROWED') {
            // å¤±è´¥ï¼šé‡å¤å€Ÿå‡º
            alert("âš ï¸ è²¸å‡ºä¸å¯:\n\nã“ã®å®¹å™¨ã¯æ—¢ã«è²¸å‡ºä¸­ã§ã™ã€‚\nå…ˆã«è¿”å´ã—ã¦ãã ã•ã„ã€‚\n(This container is not returned yet)");
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥é‡æ–°æ‰«å…¶ä»–çš„
            btn.disabled = false;
            btn.innerText = "Scan Another"; 
        } else {
            // å…¶ä»–é”™è¯¯
            alert("System Error: " + data.message);
            btn.disabled = false;
            btn.innerText = "Retry";
        }
        })
        .catch(err => {
        // ç½‘ç»œé€šè®¯å±‚é¢çš„é”™è¯¯
        console.error(err);
        alert("Network Error: " + err);
        btn.disabled = false;
        btn.innerText = "Retry";
        });
    }
      function showSuccessAnimation() {
        // éšè—å€Ÿå‡ºç•Œé¢ï¼Œæ˜¾ç¤ºæˆåŠŸç•Œé¢
        document.getElementById('borrow-view').style.display = 'none';
        document.getElementById('success-view').style.display = 'block';
        
        // 3ç§’åè‡ªåŠ¨å…³é—­
        setTimeout(() => {
          liff.closeWindow();
        }, 3000);
      }
    </script>
  </body>
</html>
