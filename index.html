<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megloo å€Ÿå‡ºç¡®è®¤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body { font-family: -apple-system, sans-serif; padding: 20px; text-align: center; background-color: #f5f5f5; }
      .card { background: white; padding: 30px 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px; }
      .container-id { font-size: 36px; font-weight: 800; color: #06C755; margin: 20px 0; display: block; }
      button { background-color: #06C755; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 50px; width: 100%; font-weight: bold; cursor: pointer; transition: opacity 0.3s; }
      button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }
      #status { margin-top: 15px; font-size: 13px; color: #888; }
    </style>
  </head>
  <body>
    <div class="card">
      <h3>Megloo å®¹å™¨å€Ÿå‡º</h3>
      <p>ä»¥ä¸‹ã®å®¹å™¨ã‚’å€Ÿã‚Šã¾ã™ã‹ï¼Ÿ</p>
      
      <span id="cid-display" class="container-id">Loading...</span>
      
      <button id="btn-borrow" onclick="handleBorrow()" disabled>åˆæœŸåŒ–ä¸­...</button>
      <div id="status">ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šä¸­...</div>
    </div>

    <script>
      // GAS éƒ¨ç½²ç”Ÿæˆçš„ URL
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxeicIpm-iDir_5LK2TKvp5Q5ERUJgQhF4pzEXPYIILVnXsGRHGJ5aaPtfU0f6vz4vP/exec";
      const MY_LIFF_ID = "2008626930-AddPwDy7"; 

      let containerId = "";

      // 1. é¡µé¢å¯åŠ¨ï¼šä» URL è·å– ID (GitHub Pages æ²¡æœ‰é‡å®šå‘ï¼Œå¯ä»¥ç›´æ¥è¯»ï¼)
      window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        containerId = urlParams.get('id');

        if (!containerId) {
          // å®¹é”™ï¼šæœ‰æ—¶å€™å‚æ•°ä¼šè·‘è¿› liff.state é‡Œ
          const liffState = urlParams.get('liff.state');
          if (liffState && liffState.includes('id=')) {
             containerId = liffState.split('id=')[1];
          }
        }

        if (containerId) {
          document.getElementById('cid-display').innerText = containerId;
          initializeLiff();
        } else {
          document.getElementById('cid-display').innerText = "ERROR";
          document.getElementById('status').innerText = "QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ";
        }
      };

      // 2. åˆå§‹åŒ– LIFF
      function initializeLiff() {
        liff.init({ liffId: MY_LIFF_ID })
          .then(() => {
            // âœ… GitHub Pages ç¯å¢ƒæåº¦ç¨³å®šï¼Œè¿™é‡Œå‡ ä¹ç§’å¼€
            if (liff.isLoggedIn()) {
               readyToGo();
            } else {
               // æ²¡ç™»å½•å°±å»ç™»å½• (GitHub Pages ä¸ä¼šä¸¢å¤±å‚æ•°ï¼Œå¯ä»¥ç›´æ¥ login)
               liff.login(); 
            }
          })
          .catch((err) => {
            document.getElementById('status').innerText = "Init Error: " + err;
          });
      }

      function readyToGo() {
        document.getElementById('status').innerText = "æº–å‚™å®Œäº†";
        const btn = document.getElementById('btn-borrow');
        btn.disabled = false;
        btn.innerText = "ã¯ã„ (ç¢ºèª)";
      }

      // 3. ç‚¹å‡»å€Ÿå‡ºï¼šå‘é€ API è¯·æ±‚
      function handleBorrow() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        // è·å– User ID
        const idToken = liff.getDecodedIDToken();
        if (!idToken || !idToken.sub) {
           alert("UserIDå–å¾—å¤±æ•—ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
           liff.login();
           return;
        }
        const userId = idToken.sub;

        // ğŸš€ ä½¿ç”¨ fetch å‘é€æ•°æ®ç»™ GAS åç«¯
        // mode: 'no-cors' æ˜¯å…³é”®ï¼å› ä¸º GAS ä¸æ”¯æŒæ ‡å‡†çš„ CORS å“åº”
        fetch(GAS_API_URL, {
          method: 'POST',
          mode: 'no-cors', 
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            containerId: containerId
          })
        }).then(() => {
          // å› ä¸º no-cors æ¨¡å¼ä¸‹æˆ‘ä»¬çœ‹ä¸åˆ°è¿”å›å€¼ï¼Œåªè¦ä¸æŠ¥é”™å°±ç®—æˆåŠŸ
          alert("è²¸å‡ºå®Œäº†ï¼ğŸ±");
          liff.closeWindow();
        }).catch(err => {
          alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
          btn.disabled = false;
          btn.innerText = "å†è©¦è¡Œ";
        });
      }
    </script>
  </body>
</html>