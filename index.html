<!-- <!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megloo å€Ÿå‡ºç¡®è®¤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body { font-family: -apple-system, sans-serif; padding: 20px; text-align: center; background-color: #f5f5f5; }
      .card { background: white; padding: 30px 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px; }
      .container-id { font-size: 36px; font-weight: 800; color: #06C755; margin: 20px 0; display: block; }
      button { background-color: #06C755; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 50px; width: 100%; font-weight: bold; cursor: pointer; transition: opacity 0.3s; }
      button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }
      #status { margin-top: 15px; font-size: 13px; color: #888; }
    </style>
  </head>
  <body>
    <div class="card">
      <h3>Project Re:Turn è²¸å‡ºã‚·ã‚¹ãƒ†ãƒ  2.61</h3>
      <p>ã“ã®å®¹å™¨ã‚’å€Ÿã‚Šã¾ã™ã‹ï¼Ÿ</p>
      
      <span id="cid-display" class="container-id">Loading...</span>
      
      <button id="btn-borrow" onclick="handleBorrow()" disabled>åˆæœŸåŒ–ä¸­...</button>
      <div id="status">ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šä¸­...</div>
    </div>

    <script>
      // GAS éƒ¨ç½²ç”Ÿæˆçš„ URL
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxeicIpm-iDir_5LK2TKvp5Q5ERUJgQhF4pzEXPYIILVnXsGRHGJ5aaPtfU0f6vz4vP/exec";
      const MY_LIFF_ID = "2008626930-AddPwDy7"; 

      let containerId = "";

      // 1. é¡µé¢å¯åŠ¨ï¼šä» URL è·å– ID (GitHub Pages æ²¡æœ‰é‡å®šå‘ï¼Œå¯ä»¥ç›´æ¥è¯»ï¼)
      window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        containerId = urlParams.get('id');

        if (!containerId) {
          // å®¹é”™ï¼šæœ‰æ—¶å€™å‚æ•°ä¼šè·‘è¿› liff.state é‡Œ
          const liffState = urlParams.get('liff.state');
          if (liffState && liffState.includes('id=')) {
             containerId = liffState.split('id=')[1];
          }
        }

        if (containerId) {
          document.getElementById('cid-display').innerText = containerId;
          initializeLiff();
        } else {
          document.getElementById('cid-display').innerText = "ERROR";
          document.getElementById('status').innerText = "QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ";
        }
      };

      // 2. åˆå§‹åŒ– LIFF
      function initializeLiff() {
        liff.init({ liffId: MY_LIFF_ID })
          .then(() => {
            // âœ… GitHub Pages ç¯å¢ƒæåº¦ç¨³å®šï¼Œè¿™é‡Œå‡ ä¹ç§’å¼€
            if (liff.isLoggedIn()) {
               readyToGo();
            } else {
               // æ²¡ç™»å½•å°±å»ç™»å½• (GitHub Pages ä¸ä¼šä¸¢å¤±å‚æ•°ï¼Œå¯ä»¥ç›´æ¥ login)
               liff.login(); 
            }
          })
          .catch((err) => {
            document.getElementById('status').innerText = "Init Error: " + err;
          });
      }

      function readyToGo() {
        document.getElementById('status').innerText = "æº–å‚™å®Œäº†";
        const btn = document.getElementById('btn-borrow');
        btn.disabled = false;
        btn.innerText = "ã¯ã„";
      }

      // 3. ç‚¹å‡»å€Ÿå‡ºï¼šå‘é€ API è¯·æ±‚
      function handleBorrow() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        // è·å– User ID
        const idToken = liff.getDecodedIDToken();
        if (!idToken || !idToken.sub) {
           alert("UserIDå–å¾—å¤±æ•—ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
           liff.login();
           return;
        }
        const userId = idToken.sub;

        // ğŸš€ ä½¿ç”¨ fetch å‘é€æ•°æ®ç»™ GAS åç«¯
        // mode: 'no-cors' æ˜¯å…³é”®ï¼å› ä¸º GAS ä¸æ”¯æŒæ ‡å‡†çš„ CORS å“åº”
        fetch(GAS_API_URL, {
          method: 'POST',
          mode: 'no-cors', 
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            containerId: containerId
          })
        }).then(() => {
          // å› ä¸º no-cors æ¨¡å¼ä¸‹æˆ‘ä»¬çœ‹ä¸åˆ°è¿”å›å€¼ï¼Œåªè¦ä¸æŠ¥é”™å°±ç®—æˆåŠŸ
          alert("è²¸å‡ºå®Œäº†ï¼ğŸ±");
          liff.closeWindow();
        }).catch(err => {
          alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
          btn.disabled = false;
          btn.innerText = "å†è©¦è¡Œ";
        });
      }
    </script>
  </body>
</html> -->


<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Re:Turn Borrow System</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      /* --- å…¨å±€æ ·å¼ --- */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro JP", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
        background-color: #F2F5F8;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        color: #333;
        -webkit-font-smoothing: antialiased;
      }

      /* --- å¡ç‰‡å®¹å™¨ (å¸¦å…¥åœºåŠ¨ç”») --- */
      .card {
        background: white;
        width: 85%;
        max-width: 360px;
        padding: 40px 30px;
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        text-align: center;
        animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
        overflow: hidden;
      }

      /* --- æ ‡é¢˜ä¸æ–‡å­— --- */
      h1 {
        margin: 0 0 10px 0;
        font-size: 20px;
        font-weight: 700;
        color: #111;
        letter-spacing: 0.05em;
      }
      p.subtitle {
        margin: 0 0 30px 0;
        font-size: 13px;
        color: #888;
      }

      /* --- å®¹å™¨IDå±•ç¤ºåŒº --- */
      .id-wrapper {
        background: #F7F9FB;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px dashed #E0E0E0;
        transition: all 0.3s;
      }
      
      .label {
        font-size: 11px;
        font-weight: 700;
        color: #06C755;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
        display: block;
      }

      .container-id {
        font-size: 38px;
        font-weight: 800;
        color: #333;
        font-feature-settings: "tnum"; /* ç­‰å®½æ•°å­— */
        letter-spacing: 1px;
      }

      /* --- æŒ‰é’®æ ·å¼ --- */
      button {
        background-color: #06C755;
        color: white;
        border: none;
        padding: 18px;
        font-size: 16px;
        border-radius: 50px;
        width: 100%;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      
      button:active {
        transform: scale(0.96);
        box-shadow: 0 2px 8px rgba(6, 199, 85, 0.2);
      }

      button:disabled {
        background-color: #E0E0E0;
        color: #999;
        box-shadow: none;
        cursor: not-allowed;
        transform: none;
      }

      /* --- åº•éƒ¨ç½²å (Credit) --- */
      .credit {
        margin-top: 40px;
        font-size: 10px;
        color: #AAA;
        font-weight: 500;
        letter-spacing: 0.5px;
        opacity: 0.8;
      }

      /* --- åŠ¨ç”»å…³é”®å¸§ --- */
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
      }
      
      .loading-text { animation: pulse 1.5s infinite; }

      /* --- æˆåŠŸçŠ¶æ€çš„æ ·å¼ --- */
      .success-view {
        display: none;
      }
      .success-icon {
        width: 80px;
        height: 80px;
        background: #06C755;
        border-radius: 50%;
        color: white;
        font-size: 40px;
        line-height: 80px;
        margin: 0 auto 20px auto;
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes popIn {
        from { transform: scale(0); }
        to { transform: scale(1); }
      }

    </style>
  </head>
  <body>

    <div class="card" id="main-card">
      <div id="borrow-view">
        <h1>Re:Turn è²¸å‡ºã‚·ã‚¹ãƒ†ãƒ </h1>
        <p class="subtitle">ã“ã®å®¹å™¨ã‚’å€Ÿã‚Šã¾ã™ã‹ï¼Ÿ</p>
        
        <div class="id-wrapper">
          <span class="label">Container ID</span>
          <div id="cid-display" class="container-id loading-text">...</div>
        </div>
        
        <button id="btn-borrow" onclick="handleBorrow()" disabled>
          ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šä¸­...
        </button>
      </div>

      <div id="success-view" class="success-view">
        <div class="success-icon">âœ“</div>
        <h2>è²¸å‡ºå®Œäº†</h2>
        <p style="color:#666; font-size:14px;">ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼<br>ç¾å‘³ã—ãå¬ã—ä¸ŠãŒã‚ŒğŸ±</p>
      </div>
    </div>

    <div class="credit">
        Version 2.70 - Designed & Produced by Kouzen Jo
    </div>

    <script>
      // GAS API åœ°å€
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxeicIpm-iDir_5LK2TKvp5Q5ERUJgQhF4pzEXPYIILVnXsGRHGJ5aaPtfU0f6vz4vP/exec";
      const MY_LIFF_ID = "2008626930-AddPwDy7"; 

      let containerId = "";

      // 1. åˆå§‹åŒ–
      window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        containerId = urlParams.get('id');

        if (!containerId) {
          // å°è¯•ä» liff.state æ‰¾
          const liffState = urlParams.get('liff.state');
          if (liffState && liffState.includes('id=')) {
             containerId = liffState.split('id=')[1];
          }
        }

        if (containerId) {
          // æ¸²æŸ“ ID
          const displayEl = document.getElementById('cid-display');
          displayEl.innerText = containerId;
          displayEl.classList.remove('loading-text'); // åœæ­¢é—ªçƒ
          
          initializeLiff();
        } else {
          document.getElementById('cid-display').innerText = "ERROR";
          document.getElementById('cid-display').style.color = "red";
          document.getElementById('btn-borrow').innerText = "QRã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼";
        }
      };

      // 2. LIFF Init
      function initializeLiff() {
        liff.init({ liffId: MY_LIFF_ID })
          .then(() => {
            if (liff.isLoggedIn()) {
               readyToGo();
            } else {
               liff.login(); 
            }
          })
          .catch((err) => {
            alert("Init Error: " + err);
          });
      }

      function readyToGo() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = false;
        btn.innerText = "ã¯ã„"; // æŒ‰é’®å˜ç»¿
      }

      // 3. ç‚¹å‡»å€Ÿå‡º
      function handleBorrow() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = true;
        btn.innerText = "å‡¦ç†ä¸­..."; // æŒ‰é’®å˜ç°

        const idToken = liff.getDecodedIDToken();
        if (!idToken || !idToken.sub) {
           alert("UserID Error. Reloading...");
           location.reload();
           return;
        }
        const userId = idToken.sub;

        // å‘é€è¯·æ±‚
        fetch(GAS_API_URL, {
          method: 'POST',
          mode: 'no-cors', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userId, containerId: containerId })
        }).then(() => {
          // åˆ‡æ¢ç•Œé¢æ˜¾ç¤ºåŠ¨ç”»
          showSuccessAnimation();
        }).catch(err => {
          alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
          btn.disabled = false;
          btn.innerText = "å†è©¦è¡Œ";
        });
      }

      function showSuccessAnimation() {
        document.getElementById('borrow-view').style.display = 'none';
        document.getElementById('success-view').style.display = 'block';
        
        // 2ç§’åè‡ªåŠ¨å…³é—­çª—å£
        setTimeout(() => {
          liff.closeWindow();
        }, 2500);
      }
    </script>
  </body>
</html>