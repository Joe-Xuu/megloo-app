<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Re:Turn Borrow System Ver. 2.77</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
      /* --- 1. å¼€å±åŠ¨ç”»æ ·å¼ (Splash Screen) --- */
      #splash-screen {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: #06C755; /* LINE Green */
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 0.8s ease-out, visibility 0.8s;
      }
      .splash-text {
        color: white;
        font-family: 'Montserrat', sans-serif;
        font-size: 48px;
        font-weight: 800;
        letter-spacing: 2px;
        animation: scalePulse 2s infinite;
      }
      /* å¼€å±æ¶ˆå¤±çš„ç±» */
      .fade-out {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      /* --- å…¨å±€æ ·å¼ --- */
      body {
        font-family: "Noto Sans JP", -apple-system, sans-serif;
        background-color: #ffffff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px 0;
        color: #333;
      }

      /* --- 2. Logo æ ·å¼ --- */
      .top-logo {
        height: 50px; /* æ ¹æ®å®é™…å›¾ç‰‡è°ƒæ•´ */
        margin-bottom: 20px;
        object-fit: contain;
      }
      
      .bottom-logos {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 30px;
        margin-bottom: 10px;
      }
      .small-logo {
        height: 30px; /* åº•éƒ¨ Logo å°ä¸€ç‚¹ */
        opacity: 0.8;
      }

      /* --- å¡ç‰‡å®¹å™¨ --- */
      .card {
        background: white;
        width: 85%;
        max-width: 340px;
        padding: 40px 30px;
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        border: 1px solid #f0f0f0;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      /* --- å­—ä½“ä¸IDæ ·å¼ --- */
      h1 { margin: 0; font-size: 22px; font-weight: 700; color: #111; }
      p.subtitle { margin: 5px 0 25px 0; font-size: 12px; color: #888; }

      .id-wrapper {
        background: #F7F9FB;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px dashed #E0E0E0;
      }
      .label { font-size: 11px; font-weight: 700; color: #06C755; display: block; margin-bottom: 5px;}
      .container-id { font-size: 36px; font-weight: 800; color: #333; font-family: 'Montserrat', sans-serif;}

      /* --- æŒ‰é’®æ ·å¼ --- */
      button {
        background-color: #06C755; color: white; border: none; padding: 16px;
        font-size: 16px; border-radius: 50px; width: 100%; font-weight: 700;
        cursor: pointer; box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3);
        transition: transform 0.1s;
      }
      button:active { transform: scale(0.96); }
      button:disabled { background-color: #E0E0E0; color: #999; box-shadow: none; }

      /* --- 3. CO2 ç‚«é…·ç‰¹æ•ˆæ ·å¼ --- */
      .success-view { display: none; }
      
      .co2-badge {
        background: linear-gradient(135deg, #e0f7fa 0%, #e8f5e9 100%);
        border: 1px solid #b9f6ca;
        padding: 15px;
        border-radius: 12px;
        margin-top: 20px;
        animation: slideUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      
      .co2-text {
        font-size: 12px; color: #555; display: block; margin-bottom: 4px;
      }
      
      /* ç‚«é…·çš„æ¸å˜å¤§å­— */
      .co2-number {
        font-family: 'Montserrat', sans-serif;
        font-size: 32px;
        font-weight: 900;
        background: linear-gradient(45deg, #00C853, #009688);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: inline-block;
      }

      .leaf-icon { font-size: 24px; vertical-align: middle; margin-left: 5px;}

      /* --- åŠ¨ç”» Keyframes --- */
      @keyframes scalePulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes popIn {
        from { transform: scale(0); } 
        to { transform: scale(1); }
      }

      .credit { margin-top: 40px; font-size: 10px; color: #B0B0B0; font-family: sans-serif;}
    </style>
  </head>
  <body>

    <div id="splash-screen">
      <div class="splash-text">Re:Turn</div>
    </div>

    <img src="sfc_logo.png" class="top-logo" alt="Keio SFC">

    <div class="card" id="main-card">
      <div id="borrow-view">
        <h1>Re:Turn è²¸å‡ºã‚·ã‚¹ãƒ†ãƒ </h1>
        <p class="subtitle">ã“ã®å®¹å™¨ã‚’å€Ÿã‚Šã¾ã™ã‹ï¼Ÿ</p>
        
        <div class="id-wrapper">
          <span class="label">Container ID</span>
          <div id="cid-display" class="container-id">...</div>
        </div>
        
        <button id="btn-borrow" onclick="handleBorrow()" disabled>
          Loading System...
        </button>
      </div>

      <div id="success-view" class="success-view">
        <div style="font-size: 60px; color: #06C755; animation: popIn 0.5s;">âœ“</div>
        <h2 style="margin: 10px 0;">è²¸å‡ºå®Œäº†</h2>
        
        <div class="co2-badge">
          <span class="co2-text">CO2å‰Šæ¸›è²¢çŒ®é‡</span>
          <div>
            <span class="co2-number">-12g</span>
            <span class="leaf-icon">ğŸƒ</span>
          </div>
        </div>
        
        <p style="color:#999; font-size:12px; margin-top:15px;">
          ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
        </p>
      </div>
    </div>

    <div class="bottom-logos">
      <img src="lab_logo.png" class="small-logo" alt="Lab Logo">
      <img src="megloo_logo.png" class="small-logo" alt="Megloo Logo">
    </div>

    <div class="credit">
        Keio SFC Wada Lab | 2025 Â© Designed & Developed by Kouzen Jo
    </div>

    <script>
      // ğŸ”´ è¯·æ›¿æ¢ä¸ºä½ çš„ GAS URL
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxeicIpm-iDir_5LK2TKvp5Q5ERUJgQhF4pzEXPYIILVnXsGRHGJ5aaPtfU0f6vz4vP/exec";
      const MY_LIFF_ID = "2008626930-AddPwDy7"; 

      let containerId = "";

      window.onload = function() {
        // --- å¼€å±åŠ¨ç”»é€»è¾‘ ---
        // é¡µé¢åŠ è½½ 1.5ç§’ åï¼Œè®©ç»¿è‰²å±å¹•æ¶ˆå¤±
        setTimeout(() => {
          document.getElementById('splash-screen').classList.add('fade-out');
        }, 1500);

        // --- åŸæœ‰é€»è¾‘ ---
        const urlParams = new URLSearchParams(window.location.search);
        containerId = urlParams.get('id');
        if (!containerId) {
          const liffState = urlParams.get('liff.state');
          if (liffState && liffState.includes('id=')) containerId = liffState.split('id=')[1];
        }

        if (containerId) {
          document.getElementById('cid-display').innerText = containerId;
          initializeLiff();
        } else {
          document.getElementById('cid-display').innerText = "ERROR";
          document.getElementById('btn-borrow').innerText = "QRã‚¨ãƒ©ãƒ¼";
        }
      };

      function initializeLiff() {
        liff.init({ liffId: MY_LIFF_ID }).then(() => {
          if (liff.isLoggedIn()) {
             readyToGo();
          } else {
             liff.login(); 
          }
        });
      }

      function readyToGo() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = false;
        btn.innerText = "ã¯ã„";
      }

      function handleBorrow() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        const idToken = liff.getDecodedIDToken();
        if (!idToken) { location.reload(); return; }
        const userId = idToken.sub;

        fetch(GAS_API_URL, {
          method: 'POST',
          mode: 'no-cors', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userId, containerId: containerId })
        }).then(() => {
          showSuccessAnimation();
        }).catch(err => {
          alert("Error: " + err);
          btn.disabled = false;
          btn.innerText = "Retry";
        });
      }

      function showSuccessAnimation() {
        // éšè—å€Ÿå‡ºç•Œé¢ï¼Œæ˜¾ç¤ºæˆåŠŸç•Œé¢
        document.getElementById('borrow-view').style.display = 'none';
        document.getElementById('success-view').style.display = 'block';
        
        // 3ç§’åè‡ªåŠ¨å…³é—­
        setTimeout(() => {
          liff.closeWindow();
        }, 3000);
      }
    </script>
  </body>
</html>
<!-- 
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Re:Turn Borrow System</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      /* --- å…¨å±€æ ·å¼ --- */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro JP", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
        background-color: #F2F5F8;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        color: #333;
        -webkit-font-smoothing: antialiased;
      }

      /* --- å¡ç‰‡å®¹å™¨ (å¸¦å…¥åœºåŠ¨ç”») --- */
      .card {
        background: white;
        width: 85%;
        max-width: 360px;
        padding: 40px 30px;
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        text-align: center;
        animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
        overflow: hidden;
      }

      /* --- æ ‡é¢˜ä¸æ–‡å­— --- */
      h1 {
        margin: 0 0 10px 0;
        font-size: 20px;
        font-weight: 700;
        color: #111;
        letter-spacing: 0.05em;
      }
      p.subtitle {
        margin: 0 0 30px 0;
        font-size: 13px;
        color: #888;
      }

      /* --- å®¹å™¨IDå±•ç¤ºåŒº --- */
      .id-wrapper {
        background: #F7F9FB;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px dashed #E0E0E0;
        transition: all 0.3s;
      }
      
      .label {
        font-size: 11px;
        font-weight: 700;
        color: #06C755;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
        display: block;
      }

      .container-id {
        font-size: 38px;
        font-weight: 800;
        color: #333;
        font-feature-settings: "tnum"; /* ç­‰å®½æ•°å­— */
        letter-spacing: 1px;
      }

      /* --- æŒ‰é’®æ ·å¼ --- */
      button {
        background-color: #06C755;
        color: white;
        border: none;
        padding: 18px;
        font-size: 16px;
        border-radius: 50px;
        width: 100%;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      
      button:active {
        transform: scale(0.96);
        box-shadow: 0 2px 8px rgba(6, 199, 85, 0.2);
      }

      button:disabled {
        background-color: #E0E0E0;
        color: #999;
        box-shadow: none;
        cursor: not-allowed;
        transform: none;
      }

      /* --- åº•éƒ¨ç½²å (Credit) --- */
      .credit {
        margin-top: 40px;
        font-size: 10px;
        color: #AAA;
        font-weight: 500;
        letter-spacing: 0.5px;
        opacity: 0.8;
      }

      /* --- åŠ¨ç”»å…³é”®å¸§ --- */
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
      }
      
      .loading-text { animation: pulse 1.5s infinite; }

      /* --- æˆåŠŸçŠ¶æ€çš„æ ·å¼ --- */
      .success-view {
        display: none;
      }
      .success-icon {
        width: 80px;
        height: 80px;
        background: #06C755;
        border-radius: 50%;
        color: white;
        font-size: 40px;
        line-height: 80px;
        margin: 0 auto 20px auto;
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes popIn {
        from { transform: scale(0); }
        to { transform: scale(1); }
      }

    </style>
  </head>
  <body>

    <div class="card" id="main-card">
      <div id="borrow-view">
        <h1>Re:Turn è²¸å‡ºã‚·ã‚¹ãƒ†ãƒ </h1>
        <p class="subtitle">ã“ã®å®¹å™¨ã‚’å€Ÿã‚Šã¾ã™ã‹ï¼Ÿ</p>
        
        <div class="id-wrapper">
          <span class="label">Container ID</span>
          <div id="cid-display" class="container-id loading-text">...</div>
        </div>
        
        <button id="btn-borrow" onclick="handleBorrow()" disabled>
          ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šä¸­...
        </button>
      </div>

      <div id="success-view" class="success-view">
        <div class="success-icon">âœ“</div>
        <h2>è²¸å‡ºå®Œäº†</h2>
        <p style="color:#666; font-size:14px;">ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼<br>ç¾å‘³ã—ãå¬ã—ä¸ŠãŒã‚ŒğŸ±</p>
      </div>
    </div>

    <div class="credit">
        Version 2.70 - Designed & Produced by Kouzen Jo
    </div>

    <script>
      // GAS API åœ°å€
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxeicIpm-iDir_5LK2TKvp5Q5ERUJgQhF4pzEXPYIILVnXsGRHGJ5aaPtfU0f6vz4vP/exec";
      const MY_LIFF_ID = "2008626930-AddPwDy7"; 

      let containerId = "";

      // 1. åˆå§‹åŒ–
      window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        containerId = urlParams.get('id');

        if (!containerId) {
          // å°è¯•ä» liff.state æ‰¾
          const liffState = urlParams.get('liff.state');
          if (liffState && liffState.includes('id=')) {
             containerId = liffState.split('id=')[1];
          }
        }

        if (containerId) {
          // æ¸²æŸ“ ID
          const displayEl = document.getElementById('cid-display');
          displayEl.innerText = containerId;
          displayEl.classList.remove('loading-text'); // åœæ­¢é—ªçƒ
          
          initializeLiff();
        } else {
          document.getElementById('cid-display').innerText = "ERROR";
          document.getElementById('cid-display').style.color = "red";
          document.getElementById('btn-borrow').innerText = "QRã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼";
        }
      };

      // 2. LIFF Init
      function initializeLiff() {
        liff.init({ liffId: MY_LIFF_ID })
          .then(() => {
            if (liff.isLoggedIn()) {
               readyToGo();
            } else {
               liff.login(); 
            }
          })
          .catch((err) => {
            alert("Init Error: " + err);
          });
      }

      function readyToGo() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = false;
        btn.innerText = "ã¯ã„"; // æŒ‰é’®å˜ç»¿
      }

      // 3. ç‚¹å‡»å€Ÿå‡º
      function handleBorrow() {
        const btn = document.getElementById('btn-borrow');
        btn.disabled = true;
        btn.innerText = "å‡¦ç†ä¸­..."; // æŒ‰é’®å˜ç°

        const idToken = liff.getDecodedIDToken();
        if (!idToken || !idToken.sub) {
           alert("UserID Error. Reloading...");
           location.reload();
           return;
        }
        const userId = idToken.sub;

        // å‘é€è¯·æ±‚
        fetch(GAS_API_URL, {
          method: 'POST',
          mode: 'no-cors', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userId, containerId: containerId })
        }).then(() => {
          // åˆ‡æ¢ç•Œé¢æ˜¾ç¤ºåŠ¨ç”»
          showSuccessAnimation();
        }).catch(err => {
          alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
          btn.disabled = false;
          btn.innerText = "å†è©¦è¡Œ";
        });
      }

      function showSuccessAnimation() {
        document.getElementById('borrow-view').style.display = 'none';
        document.getElementById('success-view').style.display = 'block';
        
        // 2ç§’åè‡ªåŠ¨å…³é—­çª—å£
        setTimeout(() => {
          liff.closeWindow();
        }, 2500);
      }
    </script>
  </body>
</html> -->